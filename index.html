<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        #map_4b10a1b313a99206e7db66ba841efd72 {
            position: relative;
            width: 100.0%;
            height: 100.0%;
            left: 0.0%;
            top: 0.0%;
        }
        .leaflet-container { font-size: 1rem; }
    </style>
</head>
<body>
    <div class="folium-map" id="map_4b10a1b313a99206e7db66ba841efd72"></div>
    <script>
        var map_4b10a1b313a99206e7db66ba841efd72 = L.map("map_4b10a1b313a99206e7db66ba841efd72", {
            center: [33.8416, 132.7657],
            crs: L.CRS.EPSG3857,
            zoom: 10,
            zoomControl: true,
            preferCanvas: false,
        });

        var tile_layer_e7c0b8c2274621b3dd9a390ca509cb77 = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors",
            detectRetina: false,
            maxNativeZoom: 19,
            maxZoom: 19,
            minZoom: 0,
            noWrap: false,
            opacity: 1,
            subdomains: "abc",
            tms: false
        });
        tile_layer_e7c0b8c2274621b3dd9a390ca509cb77.addTo(map_4b10a1b313a99206e7db66ba841efd72);

        var hospitals = [
            // 病院データをここに追加
            // 例:
            { '施設名': '病院1', 'fX': 132.7657, 'fY': 33.8416, '胃': 'あり', '大腸': 'なし' },
            { '施設名': '病院2', 'fX': 132.7757, 'fY': 33.8516, '胃': 'なし', '大腸': 'あり' },
            { '施設名': '病院3', 'fX': 132.7857, 'fY': 33.8616, '胃': 'あり', '大腸': 'あり' },
            // 他の病院データ
        ];

        // 病院データを地図に追加する関数
        function addHospitalMarkers(map, hospitals) {
            hospitals.forEach(function(hospital) {
                var screenings = [];
                if (hospital['胃']) {
                    screenings.push('胃がん');
                }
                if (hospital['大腸']) {
                    screenings.push('大腸がん');
                }
                var screeningsText = screenings.join('、');
                var color = 'gray';
                if (screenings.includes('胃がん') && screenings.includes('大腸がん')) {
                    color = 'red';
                } else if (screenings.includes('胃がん')) {
                    color = 'blue';
                } else if (screenings.includes('大腸がん')) {
                    color = 'green';
                }
                var marker = L.marker([hospital.fY, hospital.fX], {
                    icon: L.AwesomeMarkers.icon({
                        icon: 'info-sign',
                        markerColor: color,
                        prefix: 'glyphicon'
                    })
                }).addTo(map);
                var popupContent = `<div style='width: 300px;'><b>${hospital['施設名']}</b><br>がん検診: ${screeningsText}</div>`;
                marker.bindPopup(popupContent);
            });
        }

        // 病院データを先に地図に追加
        addHospitalMarkers(map_4b10a1b313a99206e7db66ba841efd72, hospitals);

        function addCurrentLocation(map) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    var marker = L.marker([lat, lon]).addTo(map)
                        .bindPopup('Your current location')
                        .openPopup();
                    map.setView([lat, lon], 13);

                    // 現在地から最寄りの胃がん、大腸がんの病院を計算して表示
                    var stomachHospitals = hospitals.filter(function(hospital) {
                        return hospital['胃'] !== null;
                    }).map(function(hospital) {
                        var distance = Math.sqrt(Math.pow(hospital.fY - lat, 2) + Math.pow(hospital.fX - lon, 2));
                        hospital.distance = distance;
                        return hospital;
                    }).sort(function(a, b) {
                        return a.distance - b.distance;
                    }).slice(0, 3);

                    var colonHospitals = hospitals.filter(function(hospital) {
                        return hospital['大腸'] !== null;
                    }).map(function(hospital) {
                        var distance = Math.sqrt(Math.pow(hospital.fY - lat, 2) + Math.pow(hospital.fX - lon, 2));
                        hospital.distance = distance;
                        return hospital;
                    }).sort(function(a, b) {
                        return a.distance - b.distance;
                    }).slice(0, 3);

                    var stomachHospitalList = stomachHospitals.map(function(hospital) {
                        return '<li>' + hospital['施設名'] + ': ' + hospital.distance.toFixed(2) + ' km</li>';
                    }).join('');

                    var colonHospitalList = colonHospitals.map(function(hospital) {
                        return '<li>' + hospital['施設名'] + ': ' + hospital.distance.toFixed(2) + ' km</li>';
                    }).join('');

                    var nearestHospitalsPopup = L.popup()
                        .setLatLng([lat, lon])
                        .setContent('<b>Nearest Stomach Cancer Hospitals:</b><ul>' + stomachHospitalList + '</ul><b>Nearest Colon Cancer Hospitals:</b><ul>' + colonHospitalList + '</ul>')
                        .openOn(map);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        addCurrentLocation(map_4b10a1b313a99206e7db66ba841efd72);
    </script>
</body>
</html>
